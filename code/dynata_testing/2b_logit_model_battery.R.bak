source(here::here('code', 'setup.R'))

# -----------------------------------------------------------------------------
# Load the data set:

data <- read_csv(here(
  "data",
  "dynata_testing",
  "choice_data_battery.csv"
))

head(data)

glimpse(data)

data <- data %>%
  mutate(
    mileage = mileage / 10000, #3 - 6
    price = price / 10000, # 0.5 - 6
    battery_range_year0 = battery_range_year0 / 100, # 1-3
    battery_range_year3 = battery_range_year3 / 100, # 1-3
    battery_range_year8 = battery_range_year8 / 100, # 0.5 - 2
    battery_degradation = (battery_degradation * 10)
  ) %>%
  select(
    -starts_with("battery_health"),
    -starts_with("time"),
    -session_id,
    -vehicle_type,
    -battery_condition
  )

# Dummy encode
data <- cbc_encode(
  data,
  coding = 'dummy',
  ref_levels = list(battery_refurbish = 'original')
)

data_car_low <- data %>%
  filter(vehicle_typecar == 1, budgetlow == 1)
data_car_high <- data %>%
  filter(vehicle_typecar == 1, budgetlow == 0)
data_suv_low <- data %>%
  filter(vehicle_typecar == 0, budgetlow == 1)
data_suv_high <- data %>%
  filter(vehicle_typecar == 0, budgetlow == 0)

# Estimate MNL model

# First create some dummy coded variables for categorical variables
#data <- dummy_cols(data, c('battery_refurbish', 'degradation_high'))

# Clean up names of created variables

glimpse(data)

# Estimate models

run_model1 <- function(data) {
  model <- logitr(
    data = data,
    outcome = "choice",
    obsID = "obsID",
    pars = c(
      "price",
      "mileage",
      "battery_range_year3",
      "battery_range_year8",
      "battery_refurbishpackreplace",
      "battery_refurbishcellreplace",
      "no_choice"
    )
  )
  cat('N =', length(unique(data$respID)))
  return(model)
}

run_model2 <- function(data) {
  model <- logitr(
    data = data,
    outcome = "choice",
    obsID = "obsID",
    pars = c(
      "price",
      "mileage",
      "battery_range_year0",
      "battery_degradation",
      "battery_refurbishpackreplace",
      "battery_refurbishcellreplace",
      "no_choice"
    )
  )
  cat('N =', length(unique(data$respID)))
  return(model)
}

# Estimate the model
model <- run_model1(data_car_low)
model <- run_model1(data_car_high)
model <- run_model1(data_suv_low)
model <- run_model1(data_suv_high)
model <- run_model1(data)

# View summary of results
summary(model)

# Estimate the model
model <- run_model2(data_car_low)
model <- run_model2(data_car_high)
model <- run_model2(data_suv_low)
model <- run_model2(data_suv_high)
model <- run_model2(data)

# View summary of results
summary(model)
