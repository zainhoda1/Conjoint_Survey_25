<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Power Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="powerAnalysis_newcbcTools_files/libs/clipboard/clipboard.min.js"></script>
<script src="powerAnalysis_newcbcTools_files/libs/quarto-html/quarto.js"></script>
<script src="powerAnalysis_newcbcTools_files/libs/quarto-html/popper.min.js"></script>
<script src="powerAnalysis_newcbcTools_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="powerAnalysis_newcbcTools_files/libs/quarto-html/anchor.min.js"></script>
<link href="powerAnalysis_newcbcTools_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="powerAnalysis_newcbcTools_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="powerAnalysis_newcbcTools_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="powerAnalysis_newcbcTools_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="powerAnalysis_newcbcTools_files/libs/bootstrap/bootstrap-5cf72aeb05ad37414ccd9374578a01f7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Power Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="step-1-generate-profiles" class="level1">
<h1>Step 1: Generate Profiles</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>profiles <span class="ot">&lt;-</span> <span class="fu">cbc_profiles</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">veh_mileage        =</span> <span class="fu">seq</span>(<span class="dv">15000</span>, <span class="dv">50000</span>, <span class="dv">10000</span>), <span class="co">#5000</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">veh_price          =</span> <span class="dv">15000</span><span class="sc">*</span><span class="fu">seq</span>(<span class="fl">0.8</span>, <span class="fl">1.2</span>, <span class="fl">0.1</span>),</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_refurbish     =</span> <span class="fu">c</span>(<span class="st">'original'</span>, <span class="st">'cellreplace'</span>,<span class="st">'packreplace'</span>),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_range_year0 =</span> <span class="fu">seq</span>(<span class="dv">200</span>, <span class="dv">360</span>, <span class="dv">40</span>),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_degradation =</span> <span class="fu">seq</span>(<span class="fl">0.01</span>,<span class="fl">0.08</span>, <span class="fl">0.02</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>profiles</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CBC Profiles
============
veh_mileage : Continuous (4 levels, range: 15000.00-45000.00)
veh_price   : Continuous (5 levels, range: 12000.00-18000.00)
battery_refurbish: Categorical (3 levels: original, cellreplace, packreplace)
battery_range_year0: Continuous (5 levels, range: 200.00-360.00)
battery_degradation: Continuous (4 levels, range: 0.01-0.07)

Profiles: 1200
First few rows:
  profileID veh_mileage veh_price battery_refurbish battery_range_year0
1         1       15000     12000          original                 200
2         2       25000     12000          original                 200
3         3       35000     12000          original                 200
4         4       45000     12000          original                 200
5         5       15000     13500          original                 200
6         6       25000     13500          original                 200
  battery_degradation
1                0.01
2                0.01
3                0.01
4                0.01
5                0.01
6                0.01
... and 1194 more rows</code></pre>
</div>
</div>
<section id="resrictions" class="level2">
<h2 class="anchored" data-anchor-id="resrictions">Resrictions</h2>
<p>None</p>
</section>
</section>
<section id="step-2-set-up-priors" class="level1">
<h1>Step 2: Set up priors</h1>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 29%">
<col style="width: 21%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th>Attribute</th>
<th>Expectation</th>
<th>Theory</th>
<th>Suggested Sign</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>veh_price</td>
<td>Lower price preferred</td>
<td>Standard economic theory (price disutility)</td>
<td>Negative (−)</td>
</tr>
<tr class="even">
<td>veh_mileage</td>
<td>Lower mileage preferred</td>
<td>Higher mileage = older/worn vehicle</td>
<td>Negative (−)</td>
</tr>
<tr class="odd">
<td>battery_refurbish</td>
<td>Original battery &gt; pack-based refurbishment &gt; cell-based refurbishment</td>
<td>Risk aversion, resale concerns, BEV reliability</td>
<td>Negative (−)</td>
</tr>
<tr class="even">
<td>battery_range_year0</td>
<td>More range preferred</td>
<td>Reduces range anxiety</td>
<td>Positive (+)</td>
</tr>
<tr class="odd">
<td>battery_degradation</td>
<td>Less degradation preferred</td>
<td>Reflects battery health and future value</td>
<td>Negative (−)</td>
</tr>
</tbody>
</table>
<section id="fixed-parameters" class="level2">
<h2 class="anchored" data-anchor-id="fixed-parameters">Fixed Parameters</h2>
<p>For example, if the coefficient of battery degradation is -10, then:</p>
<pre><code>- A 1% increase in degradation (from 0.01 to 0.02) reduces utility by 0.10.
- A full 7% increase in degradation (from 0.01 to 0.08) would reduce utility by -0.7.</code></pre>
<p>In DCE models, utilities usually range between -2 and +2, so a utility loss of -0.7 is noticeable, but not extreme. It reflects that battery degradation is an important factor in evaluating a used EV.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>priors_fixed <span class="ot">&lt;-</span> <span class="fu">cbc_priors</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">veh_mileage          =</span> <span class="sc">-</span><span class="fl">0.00002</span>,     <span class="co"># Each 1000 mile increase reduces utility by 0.05</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">veh_price            =</span> <span class="sc">-</span><span class="fl">0.00005</span>,      <span class="co"># Each $1000 increase reduces utility by 0.1</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_refurbish =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.0</span>, <span class="sc">-</span><span class="fl">0.5</span>),   <span class="co"># Cell refurbishment least preferred</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_range_year0  =</span> <span class="fl">0.005</span>,         <span class="co"># Each 10 mile of range adds utility by 0.1</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_degradation  =</span> <span class="sc">-</span><span class="dv">3</span>          <span class="co"># Each 1% of degradation increases subtracts utility by 0.1</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>priors_fixed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CBC Prior Specifications:

veh_mileage:
  Continuous variable
  Levels: 15000, 25000, 35000, 45000 
  Fixed parameter
    Coefficient: 0

veh_price:
  Continuous variable
  Levels: 12000, 13500, 15000, 16500, 18000 
  Fixed parameter
    Coefficient: 0

battery_refurbish:
  Categorical variable
  Levels: original, cellreplace, packreplace 
  Reference level: original
  Fixed parameter
    cellreplace: -1
    packreplace: -0.5

battery_range_year0:
  Continuous variable
  Levels: 200, 240, 280, 320, 360 
  Fixed parameter
    Coefficient: 0.005

battery_degradation:
  Continuous variable
  Levels: 0.01, 0.03, 0.05, 0.07 
  Fixed parameter
    Coefficient: -3</code></pre>
</div>
</div>
</section>
<section id="random-parameters" class="level2">
<h2 class="anchored" data-anchor-id="random-parameters">Random Parameters</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>priors_random_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_priors</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">veh_mileage          =</span> <span class="sc">-</span><span class="fl">0.00002</span>,     <span class="co"># Each 1000 mile increase reduces utility by 0.05</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">veh_price =</span> <span class="sc">-</span><span class="fl">0.00005</span>, <span class="co"># Assume $1,000 price increase = -0.1 utility</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_refurbish =</span> <span class="fu">rand_spec</span>(<span class="st">"n"</span>, <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.0</span>, <span class="sc">-</span><span class="fl">0.5</span>), <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>)), <span class="co"># Reference = "original"</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_range_year0 =</span> <span class="fl">0.005</span>,   <span class="co"># Assume each extra mile = +0.01 utility</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">battery_degradation =</span> <span class="sc">-</span><span class="dv">3</span> <span class="co"># 1% increase in degradation = -0.10 utility</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>priors_random_parameter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CBC Prior Specifications:

veh_mileage:
  Continuous variable
  Levels: 15000, 25000, 35000, 45000 
  Fixed parameter
    Coefficient: 0

veh_price:
  Continuous variable
  Levels: 12000, 13500, 15000, 16500, 18000 
  Fixed parameter
    Coefficient: 0

battery_refurbish:
  Categorical variable
  Levels: original, cellreplace, packreplace 
  Reference level: original
  Random - Normal distribution
    cellreplace:
      Mean: -1
      SD:   0.1
    packreplace:
      Mean: -0.5
      SD:   0.1

battery_range_year0:
  Continuous variable
  Levels: 200, 240, 280, 320, 360 
  Fixed parameter
    Coefficient: 0.005

battery_degradation:
  Continuous variable
  Levels: 0.01, 0.03, 0.05, 0.07 
  Fixed parameter
    Coefficient: -3

Correlation Matrix:
                             battery_refurbishcellreplace
battery_refurbishcellreplace                            1
battery_refurbishpackreplace                            0
                             battery_refurbishpackreplace
battery_refurbishcellreplace                            0
battery_refurbishpackreplace                            1</code></pre>
</div>
</div>
<!-- ## Random Parameters with ln -->
<!-- For the random priors, yes "ln" forces positivity, so the best way to implement this is to just make price levels negative in your profiles. So like:  -->
<!--  veh_price          = -1*15000*seq(0.8, 1.2, 0.1) -->
<!-- Then a positive coefficient times this is a negative utility. But I wouldn't recommend using ln anyway, it's just a rather difficult distribution to work with since it has such a long tail. -->
<!-- ```{r} -->
<!-- priors_random_parameter_ln <- cbc_priors( -->
<!--   profiles = profiles, -->
<!--   veh_mileage          = -0.00005,     # Each 1000 mile increase reduces utility by 0.05 -->
<!--   veh_price = rand_spec("ln", -log(0.9999), 0.00005), # Assume $1,000 price increase = -0.1 utility -->
<!--   battery_range_year0 = rand_spec("n", 0.01, 0.005), # Assume each extra mile = +0.01 utility -->
<!--   battery_degradation = rand_spec("ln", -log(4.539993e-05), 3), # 1% increase in degradation = -0.10 utility -->
<!--   battery_refurbish = rand_spec("n", c(-1.0, -0.5), c(0.1, 0.1)) # Reference = "original" -->
<!-- ) -->
<!-- priors_random_parameter -->
<!-- ``` -->
<!-- ## Interaction Effects -->
<!-- Note: Interactions with random parameters are not supported. -->
<!-- ```{r} -->
<!-- priors_interactions <- cbc_priors( -->
<!--   profiles = profiles, -->
<!--   veh_mileage          = -0.00005,     # Fixed coefficient -->
<!--   veh_price = -0.0001,  # Assume $1,000 price increase = -0.1 utility -->
<!--     battery_refurbish = rand_spec("n", c(-1.0, -0.5), c(0.1, 0.1)), # Reference = "original" -->
<!--   battery_range_year0 = rand_spec("n", 0.01, 0.005), # Assume each extra mile = +0.01 utility -->
<!--   # battery_range_year0 = rand_spec("ln", log(0.01), 0.3),  -->
<!--   battery_degradation = -10, # 1% increase in degradation = -0.10 utility -->
<!--   interactions = list( -->
<!--     # Price & degradation: price sensitivity increases when degradation worsens. -->
<!--     int_spec( -->
<!--       between = c("veh_price", "battery_degradation"), -->
<!--       value = -0.1 -->
<!--     ) -->
<!--   ) -->
<!-- ) -->
<!-- priors_interactions -->
<!-- ``` -->
</section>
</section>
<section id="step-3-generate-designs" class="level1">
<h1>Step 3: Generate Designs</h1>
<section id="different-designs" class="level2">
<h2 class="anchored" data-anchor-id="different-designs">Different designs</h2>
<section id="random-method" class="level3">
<h3 class="anchored" data-anchor-id="random-method">Random Method</h3>
<ul>
<li><strong>random</strong>: randomly samples profiles for each respondent independently; maximum diversity but may be less statistically efficient</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>design_random_fixed_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_fixed,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"random"</span>, <span class="co"># randomized full-factorial design</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>design_random_random_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_random_parameter,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"random"</span>, <span class="co"># randomized full-factorial design</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># design_random_interactions &lt;- cbc_design(</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   profiles = profiles,</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   priors = priors_interactions,</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = "random", # randomized full-factorial design</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_resp   = 3000, # Number of respondents</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_alts   = 3,    # Number of alternatives per question</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_q      = 6,    # Number of questions per respondent #6</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   remove_dominant = TRUE</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="frequency-based-methods" class="level3">
<h3 class="anchored" data-anchor-id="frequency-based-methods">Frequency-Based Methods</h3>
<ul>
<li><strong>shortcut</strong>: balances attribute level frequencies while avoiding duplicate profiles within questions.</li>
<li><strong>minoverlap</strong>: prioritizes minimizing attribute overlap within choice questions.</li>
<li><strong>balanced</strong>: optimizes both frequency balance and pairwise attribute interactions.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>design_shortcut <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"shortcut"</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating shortcut design for 3000 respondents using 13 cores...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>design_minoverlap <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"minoverlap"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating minoverlap design for 3000 respondents using 13 cores...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>design_balanced <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"balanced"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating balanced design for 3000 respondents using 13 cores...</code></pre>
</div>
</div>
</section>
<section id="d-optimal-methods" class="level3">
<h3 class="anchored" data-anchor-id="d-optimal-methods">D-Optimal Methods</h3>
<ul>
<li><strong>stochastic</strong>: uses random profile swapping to minimize the d-error, accepting the first improvement found. This is a faster algorithm as a compromise between speed and exhaustiveness.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>design_stochastic_fixed_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"stochastic"</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_fixed,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_start =</span> <span class="dv">1</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Stochastic design will be optimized into 1 design block, then allocated across 3000 respondents</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Running 1 design searches using 13 cores...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
D-error results from all starts:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start 1: 0.001391   (Best)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>design_stochastic_random_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"stochastic"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_random_parameter,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_start =</span> <span class="dv">1</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Stochastic design will be optimized into 1 design block, then allocated across 3000 respondents</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Running 1 design searches using 13 cores...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
D-error results from all starts:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start 1: 0.001127   (Best)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># design_stochastic_interactions &lt;- cbc_design(</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   profiles = profiles,</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = "stochastic",</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_resp   = 3000, # Number of respondents</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_alts   = 3,    # Number of alternatives per question</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_q      = 6,    # Number of questions per respondent #6</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   priors = priors_interactions,</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_start = 1,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   remove_dominant = TRUE</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>modfed</strong>: exhaustively tests all possible profile swaps for each position. It is slower than other methods though more thorough.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>design_modfed_fixed_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"modfed"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_fixed,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_start =</span> <span class="dv">1</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Modfed design will be optimized into 1 design block, then allocated across 3000 respondents</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: idefix generated warnings that suggest fallback: idefix design generation failed: idefix returned design with duplicate profiles in choice set 4
Falling back to cbcTools implementation.
Falling back to cbcTools implementation.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Running 1 design searches using 13 cores...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
D-error results from all starts:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start 1: 0.000734   (Best)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>design_modfed_random_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"modfed"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_random_parameter,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_start =</span> <span class="dv">1</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Modfed design will be optimized into 1 design block, then allocated across 3000 respondents</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: par_draws has no column names, assuming standard order</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in reorder_par_draws_for_idefix(priors$par_draws, attr_mapping, :
par_draws has no column names, assuming standard order</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># design_modfed_interactions &lt;- cbc_design(</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   profiles = profiles,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = "modfed",</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_resp   = 3000, # Number of respondents</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_alts   = 3,    # Number of alternatives per question</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_q      = 6,    # Number of questions per respondent #6</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   priors = priors_interactions,</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_start = 1,</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   remove_dominant = TRUE</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>cea</strong>: optimizes attribute-by-attribute, testing all possible levels for each attribute. It is faster than “modfed”, though requires all possible profiles and cannot accept restricted profile sets.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>design_cea_fixed_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cea"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_fixed,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_start =</span> <span class="dv">1</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Cea design will be optimized into 1 design block, then allocated across 3000 respondents</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>design_cea_random_parameter <span class="ot">&lt;-</span> <span class="fu">cbc_design</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">profiles =</span> profiles,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cea"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_resp   =</span> <span class="dv">3000</span>, <span class="co"># Number of respondents</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_alts   =</span> <span class="dv">3</span>,    <span class="co"># Number of alternatives per question</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_q      =</span> <span class="dv">6</span>,    <span class="co"># Number of questions per respondent #6</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors =</span> priors_random_parameter,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_start =</span> <span class="dv">1</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">remove_dominant =</span> <span class="cn">TRUE</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Cea design will be optimized into 1 design block, then allocated across 3000 respondents</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: par_draws has no column names, assuming standard order</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in reorder_par_draws_for_idefix(priors$par_draws, attr_mapping, :
par_draws has no column names, assuming standard order</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># design_cea_interactions &lt;- cbc_design(</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   profiles = profiles,</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = "cea",</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_resp   = 3000, # Number of respondents</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_alts   = 3,    # Number of alternatives per question</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_q      = 6,    # Number of questions per respondent #6</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   priors = priors_interactions,</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_start = 1,</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   remove_dominant = TRUE</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="design-comparisons" class="level2">
<h2 class="anchored" data-anchor-id="design-comparisons">Design comparisons</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_compare</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Random_fixed_parameter"</span> <span class="ot">=</span> design_random_fixed_parameter,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Random_random_parameter"</span> <span class="ot">=</span> design_random_random_parameter,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Random_interactions" = design_random_interactions,</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Shortcut"</span> <span class="ot">=</span> design_shortcut,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Minoverlap"</span> <span class="ot">=</span> design_minoverlap,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Balanced"</span> <span class="ot">=</span> design_balanced,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stochastic_fixed_parameter"</span> <span class="ot">=</span> design_stochastic_fixed_parameter,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stochastic_random_parameter"</span> <span class="ot">=</span> design_stochastic_random_parameter,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Stochastic_interactions" = design_stochastic_interactions,</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Modfed_fixed_parameter"</span> <span class="ot">=</span> design_modfed_fixed_parameter,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Modfed_random_parameter"</span> <span class="ot">=</span> design_modfed_random_parameter,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Modfed_interactions" = design_modfed_interactions,</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CEA_fixed_parameter"</span> <span class="ot">=</span> design_cea_fixed_parameter,</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CEA_random_parameter"</span> <span class="ot">=</span> design_cea_random_parameter</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "CEA_interactions" = design_cea_interactions</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CBC Design Comparison
=====================
Designs compared: 11
Metrics: structure, efficiency, balance, overlap
Sorted by: d_error (ascending)

Structure
=====================
                      Design     Method respondents questions
        CEA_random_parameter        cea        3000         6
     Modfed_random_parameter     modfed        3000         6
      Modfed_fixed_parameter     modfed        3000         6
         CEA_fixed_parameter        cea        3000         6
 Stochastic_random_parameter stochastic        3000         6
  Stochastic_fixed_parameter stochastic        3000         6
      Random_fixed_parameter     random        3000         6
     Random_random_parameter     random        3000         6
                    Shortcut   shortcut        3000         6
                  Minoverlap minoverlap        3000         6
                    Balanced   balanced        3000         6
 Alternatives Blocks     Profile Usage
            3      1    (17/1200) 1.4%
            3      1    (17/1200) 1.4%
            3      1    (17/1200) 1.4%
            3      1    (18/1200) 1.5%
            3      1    (18/1200) 1.5%
            3      1    (18/1200) 1.5%
            3      1 (1199/1200) 99.9%
            3      1 (1199/1200) 99.9%
            3      1  (1200/1200) 100%
            3      1  (1200/1200) 100%
            3      1  (1200/1200) 100%
 No Choice Labeled?
        No       No
        No       No
        No       No
        No       No
        No       No
        No       No
        No       No
        No       No
        No       No
        No       No
        No       No

Design Metrics
=====================
                      Design     Method D-Error (Null) D-Error (Prior) Balance
        CEA_random_parameter        cea       0.000675        0.000698   0.785
     Modfed_random_parameter     modfed       0.000696        0.000728   0.831
      Modfed_fixed_parameter     modfed       0.000688        0.000734   0.893
         CEA_fixed_parameter        cea       0.000687        0.000746   0.791
 Stochastic_random_parameter stochastic       0.001028        0.001127   0.702
  Stochastic_fixed_parameter stochastic       0.001279        0.001391   0.678
      Random_fixed_parameter     random             NA              NA   0.886
     Random_random_parameter     random             NA              NA   0.883
                    Shortcut   shortcut             NA              NA   0.892
                  Minoverlap minoverlap             NA              NA   0.891
                    Balanced   balanced             NA              NA   0.892
 Overlap
   0.000
   0.000
   0.000
   0.000
   0.111
   0.056
   0.141
   0.141
   0.000
   0.000
   0.000

Interpretation:
- D-Error: Lower is better (design efficiency)
- Balance: Higher is better (level distribution)
- Overlap: Lower is better (attribute variation)
- Profile Usage: Higher means more profiles used

Best performers:
- D-Error: CEA_random_parameter (0.000698)
- Balance: Modfed_fixed_parameter (0.893)
- Overlap: CEA_random_parameter (0.000)
- Profile Usage: Shortcut (100.0%)

Use summary() for detailed information on any one design.</code></pre>
</div>
</div>
</section>
</section>
<section id="step-4-inspect-design" class="level1">
<h1>Step 4: Inspect Design</h1>
<p><strong>Goal: Evaluate the quality and properties of the design.</strong> - D-error: Lower values indicate more efficient designs - Balance: Higher scores indicate better attribute level balance - Overlap: Lower scores indicate less attribute overlap within questions - Profile usage: Higher percentages indicate better use of available profiles</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_random_random_parameter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: random
Created: 2025-07-14 10:58:05
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 1199/1200 (99.9%)
Special features:
  • Dominance removal: total, partial

SUMMARY METRICS
=================
D-error calculation not available for random designs
Overall balance score: 0.883 (higher is better)
Overall overlap score: 0.141 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.883 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 25000 35000 45000 
13266 13881 13643 13210 
  Balance score: 0.977 (higher is better)

veh_price:

12000 13500 15000 16500 18000 
10621 10859 10807 10835 10878 
  Balance score: 0.991 (higher is better)

battery_refurbishcellreplace:

    0     1 
35881 18119 
  Balance score: 0.683 (higher is better)

battery_refurbishpackreplace:

    0     1 
35827 18173 
  Balance score: 0.684 (higher is better)

battery_range_year0:

  200   240   280   320   360 
10651 10952 10906 11015 10476 
  Balance score: 0.979 (higher is better)

battery_degradation:

 0.01  0.03  0.05  0.07 
13374 13369 13742 13515 
  Balance score: 0.987 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.141 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   6.1%  (1106 / 18000 questions)
  2 (partial overlap):   56.0%  (10080 / 18000 questions)
  3 (partial overlap):   37.9%  (6814 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.32

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   3.7%  (663 / 18000 questions)
  2 (partial overlap):   48.0%  (8635 / 18000 questions)
  3 (partial overlap):   48.3%  (8702 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.45

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):  32.7%  (5890 / 18000 questions)
  2 (no overlap):        67.3%  (12110 / 18000 questions)
  Average unique levels per question: 1.67

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):  32.5%  (5850 / 18000 questions)
  2 (no overlap):        67.5%  (12150 / 18000 questions)
  Average unique levels per question: 1.68

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   3.9%  (694 / 18000 questions)
  2 (partial overlap):   47.9%  (8616 / 18000 questions)
  3 (partial overlap):   48.3%  (8690 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.44

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   5.7%  (1032 / 18000 questions)
  2 (partial overlap):   56.1%  (10090 / 18000 questions)
  3 (partial overlap):   38.2%  (6878 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.32</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_random_fixed_parameter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: random
Created: 2025-07-14 10:57:54
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 1199/1200 (99.9%)
Special features:
  • Dominance removal: total, partial

SUMMARY METRICS
=================
D-error calculation not available for random designs
Overall balance score: 0.886 (higher is better)
Overall overlap score: 0.141 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.886 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 25000 35000 45000 
13426 13634 13674 13266 
  Balance score: 0.986 (higher is better)

veh_price:

12000 13500 15000 16500 18000 
10889 10748 10814 10755 10794 
  Balance score: 0.995 (higher is better)

battery_refurbishcellreplace:

    0     1 
36182 17818 
  Balance score: 0.675 (higher is better)

battery_refurbishpackreplace:

    0     1 
35725 18275 
  Balance score: 0.686 (higher is better)

battery_range_year0:

  200   240   280   320   360 
10717 10718 11018 10973 10574 
  Balance score: 0.983 (higher is better)

battery_degradation:

 0.01  0.03  0.05  0.07 
13526 13547 13361 13566 
  Balance score: 0.993 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.141 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   6.0%  (1088 / 18000 questions)
  2 (partial overlap):   56.4%  (10155 / 18000 questions)
  3 (partial overlap):   37.5%  (6757 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.31

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   3.7%  (659 / 18000 questions)
  2 (partial overlap):   47.7%  (8583 / 18000 questions)
  3 (partial overlap):   48.7%  (8758 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.45

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):  33.3%  (6000 / 18000 questions)
  2 (no overlap):        66.7%  (12000 / 18000 questions)
  Average unique levels per question: 1.67

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):  31.9%  (5747 / 18000 questions)
  2 (no overlap):        68.1%  (12253 / 18000 questions)
  Average unique levels per question: 1.68

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   3.8%  (692 / 18000 questions)
  2 (partial overlap):   47.9%  (8630 / 18000 questions)
  3 (partial overlap):   48.2%  (8678 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.44

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   6.0%  (1079 / 18000 questions)
  2 (partial overlap):   55.9%  (10059 / 18000 questions)
  3 (partial overlap):   38.1%  (6862 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 2.32</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_shortcut)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: shortcut
Created: 2025-07-14 12:06:56
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 1200/1200 (100.0%)

SUMMARY METRICS
=================
(Lower values indicate more efficient designs)

Overall balance score: 0.892 (higher is better)
Overall overlap score: 0.000 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.892 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 25000 35000 45000 
13484 13517 13480 13519 
  Balance score: 0.998 (higher is better)

veh_price:

12000 13500 15000 16500 18000 
10827 10783 10779 10766 10845 
  Balance score: 0.997 (higher is better)

battery_refurbishcellreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_refurbishpackreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_range_year0:

  200   240   280   320   360 
10807 10774 10820 10781 10818 
  Balance score: 0.998 (higher is better)

battery_degradation:

 0.01  0.03  0.05  0.07 
13497 13450 13519 13534 
  Balance score: 0.997 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.000 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_minoverlap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: minoverlap
Created: 2025-07-14 12:25:10
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 1200/1200 (100.0%)

SUMMARY METRICS
=================
(Lower values indicate more efficient designs)

Overall balance score: 0.891 (higher is better)
Overall overlap score: 0.000 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.891 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 25000 35000 45000 
13501 13488 13515 13496 
  Balance score: 0.999 (higher is better)

veh_price:

12000 13500 15000 16500 18000 
10734 10801 10764 10789 10912 
  Balance score: 0.994 (higher is better)

battery_refurbishcellreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_refurbishpackreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_range_year0:

  200   240   280   320   360 
10792 10735 10835 10821 10817 
  Balance score: 0.996 (higher is better)

battery_degradation:

 0.01  0.03  0.05  0.07 
13484 13500 13477 13539 
  Balance score: 0.998 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.000 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_balanced)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: balanced
Created: 2025-07-14 12:44:15
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 1200/1200 (100.0%)

SUMMARY METRICS
=================
(Lower values indicate more efficient designs)

Overall balance score: 0.892 (higher is better)
Overall overlap score: 0.000 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.892 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 25000 35000 45000 
13507 13475 13506 13512 
  Balance score: 0.999 (higher is better)

veh_price:

12000 13500 15000 16500 18000 
10843 10815 10795 10800 10747 
  Balance score: 0.997 (higher is better)

battery_refurbishcellreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_refurbishpackreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_range_year0:

  200   240   280   320   360 
10775 10797 10796 10802 10830 
  Balance score: 0.998 (higher is better)

battery_degradation:

 0.01  0.03  0.05  0.07 
13461 13476 13519 13544 
  Balance score: 0.997 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.000 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (partial overlap):    0.0%  (0 / 18000 questions)
  5 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (partial overlap):    0.0%  (0 / 18000 questions)
  3 (partial overlap):  100.0%  (18000 / 18000 questions)
  4 (no overlap):         0.0%  (0 / 18000 questions)
  Average unique levels per question: 3.00</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_cea_fixed_parameter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: cea
Created: 2025-07-14 12:48:20
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 18/1200 (1.5%)
Special features:
  • Dominance removal: total, partial

SUMMARY METRICS
=================
D-error (with priors): 0.000746
D-error (null model): 0.000687
(Lower values indicate more efficient designs)

Overall balance score: 0.791 (higher is better)
Overall overlap score: 0.000 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.791 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 45000 
21000 33000 
  Balance score: 0.761 (higher is better)

veh_price:

12000 18000 
24000 30000 
  Balance score: 0.864 (higher is better)

battery_refurbishcellreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_refurbishpackreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_range_year0:

  200   360 
33000 21000 
  Balance score: 0.761 (higher is better)

battery_degradation:

 0.01  0.07 
27000 27000 
  Balance score: 1.000 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.000 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_modfed_random_parameter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: modfed
Created: 2025-07-14 12:48:18
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 17/1200 (1.4%)
Special features:
  • Dominance removal: total, partial

SUMMARY METRICS
=================
D-error (with priors): 0.000728
D-error (null model): 0.000696
(Lower values indicate more efficient designs)

Overall balance score: 0.831 (higher is better)
Overall overlap score: 0.000 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.831 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 45000 
21000 33000 
  Balance score: 0.761 (higher is better)

veh_price:

12000 18000 
27000 27000 
  Balance score: 1.000 (higher is better)

battery_refurbishcellreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_refurbishpackreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_range_year0:

  200   360 
30000 24000 
  Balance score: 0.864 (higher is better)

battery_degradation:

 0.01  0.07 
27000 27000 
  Balance score: 1.000 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.000 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_modfed_fixed_parameter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: modfed
Created: 2025-07-14 12:47:31
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 17/1200 (1.4%)
Special features:
  • Dominance removal: total, partial

SUMMARY METRICS
=================
D-error (with priors): 0.000734
D-error (null model): 0.000688
(Lower values indicate more efficient designs)

Overall balance score: 0.893 (higher is better)
Overall overlap score: 0.000 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.893 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 45000 
27000 27000 
  Balance score: 1.000 (higher is better)

veh_price:

12000 18000 
27000 27000 
  Balance score: 1.000 (higher is better)

battery_refurbishcellreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_refurbishpackreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_range_year0:

  200   360 
27000 27000 
  Balance score: 1.000 (higher is better)

battery_degradation:

 0.01  0.07 
27000 27000 
  Balance score: 1.000 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.000 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbc_inspect</span>(design_cea_random_parameter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DESIGN SUMMARY
=========================

STRUCTURE
================
Method: cea
Created: 2025-07-14 12:48:23
Respondents: 3000
Questions per respondent: 6
Alternatives per question: 3
Total choice sets: 18000
Profile usage: 17/1200 (1.4%)
Special features:
  • Dominance removal: total, partial

SUMMARY METRICS
=================
D-error (with priors): 0.000698
D-error (null model): 0.000675
(Lower values indicate more efficient designs)

Overall balance score: 0.785 (higher is better)
Overall overlap score: 0.000 (lower is better)

VARIABLE ENCODING
=================
Format: Dummy-coded (battery_refurbish)
💡 Use cbc_decode_design() to convert to categorical format

ATTRIBUTE BALANCE
=================
Overall balance score: 0.785 (higher is better)

Individual attribute level counts:

veh_mileage:

15000 45000 
21000 33000 
  Balance score: 0.761 (higher is better)

veh_price:

12000 18000 
24000 30000 
  Balance score: 0.864 (higher is better)

battery_refurbishcellreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_refurbishpackreplace:

    0     1 
36000 18000 
  Balance score: 0.680 (higher is better)

battery_range_year0:

  200   360 
30000 24000 
  Balance score: 0.864 (higher is better)

battery_degradation:

 0.01  0.07 
30000 24000 
  Balance score: 0.864 (higher is better)

ATTRIBUTE OVERLAP
=================
Overall overlap score: 0.000 (lower is better)

Counts of attribute overlap:
(# of questions with N unique levels)

veh_mileage: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

veh_price: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishcellreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_refurbishpackreplace: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_range_year0: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00

battery_degradation: Continuous variable
  Questions by # unique levels:
  1 (complete overlap):   0.0%  (0 / 18000 questions)
  2 (no overlap):       100.0%  (18000 / 18000 questions)
  Average unique levels per question: 2.00</code></pre>
</div>
</div>
<!-- # Step 5: Simulate Choices -->
<!-- ```{r} -->
<!-- choices_random_fixed_parameter <- cbc_choices(design_random_fixed_parameter, priors = priors_fixed) -->
<!-- choices_random_random_parameter <- cbc_choices(design_random_random_parameter, priors = priors_random_parameter) -->
<!-- choices_shortcut <- cbc_choices(design_shortcut) -->
<!-- choices_minoverlap <- cbc_choices(design_minoverlap) -->
<!-- choices_balanced <- cbc_choices(design_balanced) -->
<!-- choices_cea_fixed_parameter <- cbc_choices(design_cea_fixed_parameter, priors = priors_fixed) -->
<!-- choices_cea_random_parameter <- cbc_choices(design_cea_random_parameter, priors = priors_random_parameter) -->
<!-- choices_modfed_fixed_parameter <- cbc_choices(design_modfed_fixed_parameter, priors = priors_fixed) -->
<!-- choices_modfed_random_parameter <- cbc_choices(design_modfed_random_parameter, priors = priors_random_parameter) -->
<!-- ``` -->
<!-- ## random_fixed_parameter -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_random_fixed_parameter) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## random_random_parameter -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_random_random_parameter) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## shortcut -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_shortcut) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## minoverlap -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_minoverlap) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## balanced -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_balanced) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## cea_fixed_parameter -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_cea_fixed_parameter) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## cea_random_parameter -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_cea_random_parameter) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## modfed_fixed_parameter -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_modfed_fixed_parameter) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- ## modfed_random_parameter -->
<!-- ```{r} -->
<!-- choices_cat <- cbc_decode(choices_modfed_random_parameter) -->
<!-- # Filter for the chosen rows only -->
<!-- choices_cat <- choices_cat[which(choices_cat$choice == 1), ] -->
<!-- # Counts of choices made for each attribute level -->
<!-- table(choices_cat$veh_mileage) -->
<!-- table(choices_cat$veh_price) -->
<!-- table(choices_cat$battery_refurbish) -->
<!-- table(choices_cat$battery_range_year0) -->
<!-- table(choices_cat$battery_degradation) -->
<!-- ``` -->
<!-- # Step 6: Assess Power -->
<!-- ```{r} -->
<!-- power_random_fixed_parameter <- cbc_power(choices_random_fixed_parameter) -->
<!-- plot(power_random_fixed_parameter, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_random_random_parameter <- cbc_power(choices_random_random_parameter) -->
<!-- plot(power_random_random_parameter, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_shortcut <- cbc_power(choices_shortcut) -->
<!-- plot(power_shortcut, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_minoverlap <- cbc_power(choices_minoverlap) -->
<!-- plot(power_minoverlap, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_balanced <- cbc_power(choices_balanced) -->
<!-- plot(power_balanced, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_cea_fixed_parameter <- cbc_power(choices_cea_fixed_parameter) -->
<!-- plot(power_cea_fixed_parameter, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_cea_random_parameter <- cbc_power(choices_cea_random_parameter) -->
<!-- plot(power_cea_random_parameter, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_modfed_fixed_parameter <- cbc_power(choices_modfed_fixed_parameter) -->
<!-- plot(power_modfed_fixed_parameter, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_modfed_random_parameter <- cbc_power(choices_modfed_random_parameter) -->
<!-- plot(power_modfed_random_parameter, type = "power", power_threshold = 0.9) -->
<!-- ``` -->
<!-- ## Output -->
<!-- ```{r} -->
<!-- design_rand_output <-design_random %>% -->
<!--   mutate(battery_health_year0=paste0(round(1 * 100, 0), "%"), -->
<!--          battery_health_year3=(1-battery_degradation)^3, -->
<!--          battery_health_year8=(1-battery_degradation)^8, -->
<!--          # round to the closest 5 -->
<!--          battery_range_year3=round(battery_range_year0*battery_health_year3/5)*5, -->
<!--          battery_range_year8=round(battery_range_year0*battery_health_year8/5)*5, -->
<!--          battery_health_year3=paste0(round((1-battery_degradation)^3*100,0),"%"), -->
<!--          battery_health_year8=paste0(round((1-battery_degradation)^8*100,0),"%"), -->
<!--          ) %>%  -->
<!--   mutate(image_refurbishment=paste0("battery_survey_battery_", battery_refurbish, "_text",".png"), -->
<!--     image_degradation=paste0("Range_Degradation_", battery_range_year0, "_", battery_degradation*100,".png"), -->
<!--          ) %>%  -->
<!--   mutate(veh_price=veh_price/15000 -->
<!--          # battery_condition=case_when(battery_condition=="Like_new" ~ "Like new", T ~ battery_condition) -->
<!--          # charge_freq=paste0(charge_freq," times"), -->
<!--          # charge_DCFC=paste0(charge_DCFC,"%") -->
<!--          ) -->
<!-- # head(design_rand) -->
<!-- # cbc_balance(design_rand) -->
<!-- # cbc_overlap(design_rand) -->
<!-- # write.csv(design_rand, paste0(here(),"/survey/data/battery_choice_questions.csv"), row.names = FALSE) -->
<!-- # write.csv(design_rand_output, paste0(here(),"/data/battery_choice_questions.csv"), row.names = FALSE) -->
<!-- ``` -->
<!-- #----------------------------------------------- -->
<!-- # Create mileage/battery SoH images -->
<!-- ```{r} -->
<!-- design_rand <- design_rand %>% -->
<!--   mutate(battery_health_year0=1, -->
<!--          battery_health_year3=(1-battery_degradation)^3, -->
<!--          battery_health_year8=(1-battery_degradation)^8, -->
<!--          # round to the closest 5 -->
<!--          battery_range_year3=round(battery_range_year0*battery_health_year3/5)*5, -->
<!--          battery_range_year8=round(battery_range_year0*battery_health_year8/5)*5, -->
<!--          # 0 decimal -->
<!--          battery_health_year3=round(battery_health_year3,2), -->
<!--          battery_health_year8=round(battery_health_year8,2) -->
<!--          )  -->
<!-- df_battery_degradation<-design_rand %>% -->
<!--   select(battery_range_year0,battery_degradation) %>%  -->
<!--   distinct() %>%  -->
<!--   mutate(battery_degradation_id = row_number()) -->
<!-- df_range_SOH<-design_rand %>%  -->
<!--   select(contains("year")) %>%  -->
<!--   distinct()  -->
<!-- ``` -->
<!-- ## Version 1: Range \n (SoH) -outside -->
<!-- ```{r} -->
<!-- df_range_SOH_long <- df_range_SOH %>% -->
<!--   mutate(row_id = row_number()) %>% -->
<!--   pivot_longer( -->
<!--     cols = -row_id, -->
<!--     names_to = c("metric", "year"), -->
<!--     names_pattern = "(.*)_year(\\d+)", -->
<!--     values_to = "value" -->
<!--   ) %>% -->
<!--   pivot_wider( -->
<!--     names_from = metric, -->
<!--     values_from = value -->
<!--   ) %>% -->
<!--   group_by(row_id) %>% -->
<!--   mutate(battery_range_max = max(battery_range)) %>% -->
<!--   ungroup() %>% -->
<!--   left_join(df_battery_degradation %>% select(-battery_range_year0), by= c("row_id"="battery_degradation_id")) %>%  -->
<!--   mutate( -->
<!--     year = as.numeric(year), -->
<!--     label = paste0(battery_range, " mi\n(", battery_health*100, "%)"), -->
<!--     image_name = paste0("Range_Degradation_",battery_range_max, "_", battery_degradation*100), -->
<!--   ) %>% -->
<!--   select(-battery_degradation) -->
<!-- ``` -->
<!-- #### Full image -->
<!-- ```{r} -->
<!-- library(ggplot2) -->
<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- library(scales) -->
<!-- segments <- 100 -->
<!-- max_battery_health <- 1 -->
<!-- segment_width <- max_battery_health / segments -->
<!-- # Create visual bar representation by 100% -->
<!-- df_segmented <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     row_id = factor(row_id), -->
<!--     fill_color = col_numeric(c("red", "yellow", "green"), domain = c(0.4, 1))(battery_health), -->
<!--     visual_filled = ceiling(battery_health * segments), -->
<!--     y_center = as.numeric(factor(year)) -->
<!--   ) %>% -->
<!--   uncount(weights = segments, .id = "segment") %>% -->
<!--   group_by(row_id, year) %>% -->
<!--   mutate( -->
<!--     total_width = unique(battery_range_max), -->
<!--     segment_width = total_width / segments, -->
<!--     filled = segment <= visual_filled, -->
<!--     xmin = (segment - 1) * segment_width, -->
<!--     xmax = segment * segment_width, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) %>% -->
<!--   ungroup() -->
<!-- # Battery outline -->
<!-- df_battery_outline <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     y_center = as.numeric(factor(year)), -->
<!--     xmin = 0, -->
<!--     xmax = battery_range_max, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) -->
<!-- # Terminal -->
<!-- df_terminal <-df_battery_outline %>% -->
<!--   mutate( -->
<!--     xmin = battery_range_max, -->
<!--     xmax = battery_range_max + 15, -->
<!--     ymin = ymin + 0.1, -->
<!--     ymax = ymax - 0.1 -->
<!--   ) -->
<!-- # Plot -->
<!-- Range_SoH_full_image<-ggplot() + -->
<!--   geom_rect( -->
<!--     data = df_segmented, #%>% filter(row_id==1), -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = ifelse(filled, fill_color, "white")), -->
<!--     color = NA -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_battery_outline, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = NA, color = "black", linewidth = 0.6 -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_terminal, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = "black" -->
<!--   ) + -->
<!--   scale_fill_identity() + -->
<!--   facet_wrap(~ row_id) + #, scales = "free_y" -->
<!--   coord_cartesian(xlim = c(0, max(df_range_SOH_long$battery_range_max) + 300),clip = "off") + -->
<!--   scale_y_reverse(limits = c(4, 0), -->
<!--                   breaks = c(3, 2, 1),  # Positions for ticks -->
<!--                   labels = c( "Future\n(8 yrs)" ,"Current\n(3 yrs)","New\n(0 yrs)"))+ -->
<!--    geom_text( -->
<!--     data = df_range_SOH_long, -->
<!--     aes(x = battery_range_max + 40, y = as.numeric(factor(year)), label = label), -->
<!--     hjust = 0, size = 3 -->
<!--   )+ -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     axis.title = element_blank(), -->
<!--     axis.text.x = element_blank(), -->
<!--     axis.text.y = element_text(colour="black", size = 9), -->
<!--     axis.ticks = element_blank(), -->
<!--     panel.grid = element_blank(), -->
<!--     panel.background = element_rect(fill = NA, color = NA), -->
<!--     plot.background = element_rect(fill = NA, color = NA) -->
<!--   ) -->
<!-- # ggsave(plot = Range_SoH_full_image, filename  = here::here("survey","images","battery_choices", "SoH_range_full_image.png"), width = 15, height = 12) -->
<!-- ggsave(plot = Range_SoH_full_image,  -->
<!--        filename  = here::here("images","battery_choices_version1", "SoH_range_full_image.png"),  -->
<!--        bg = "transparent", -->
<!--        width = 15, height = 12) -->
<!-- ``` -->
<!-- #### Individual image -->
<!-- ```{r} -->
<!--  library(ragg) -->
<!-- # Create output directory if it doesn't exist -->
<!-- # output_dir <- here::here("survey", "images", "battery_choices") -->
<!-- output_dir <- here::here( "images", "battery_choices_version1") -->
<!-- if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE) -->
<!-- # Get unique row_ids -->
<!-- row_ids <- unique(df_segmented$row_id) -->
<!-- for (id in row_ids) { -->
<!--   # Filter data for this row_id -->
<!--   segmented_i <- df_segmented %>% filter(row_id == id) -->
<!--   outline_i   <- df_battery_outline %>% filter(row_id == id) -->
<!--   terminal_i  <- df_terminal %>% filter(row_id == id) -->
<!--   label_i     <- df_range_SOH_long %>% filter(row_id == id) -->
<!--   # Get the image name -->
<!--   image_filename <- label_i$image_name[1]  # Assuming it's the same for all years per row_id -->
<!--   # Build the plot -->
<!--   p <- ggplot() + -->
<!--     geom_rect( -->
<!--       data = segmented_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, -->
<!--           fill = ifelse(filled, fill_color, "white")), -->
<!--       color = NA -->
<!--     ) + -->
<!--     geom_rect( -->
<!--       data = outline_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--       fill = NA, color = "black", linewidth = 0.6 -->
<!--     ) + -->
<!--     geom_rect( -->
<!--       data = terminal_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--       fill = "black" -->
<!--     ) + -->
<!--     scale_fill_identity() + -->
<!--     coord_cartesian(xlim = c(0, max(df_range_SOH_long$battery_range_max) + 200),  clip = "off") + -->
<!--     scale_y_reverse( -->
<!--       limits = c(3.6, 0.4), -->
<!--       breaks = c(3, 2, 1), -->
<!--       labels = c("Future\n(8 yrs)", "Current\n(3 yrs)", "New\n(0 yrs)") -->
<!--     ) + -->
<!--     geom_text( -->
<!--       data = label_i, -->
<!--       aes(x = battery_range_max + 30, y = as.numeric(factor(year)), label = label), -->
<!--       hjust = 0, size = 6 -->
<!--     ) + -->
<!--     theme_minimal() + -->
<!--     theme( -->
<!--       axis.title = element_blank(), -->
<!--       axis.text.x =element_blank(), -->
<!--       axis.text.y = element_text(colour = "black", size = 15), -->
<!--       axis.ticks = element_blank(), -->
<!--       panel.grid = element_blank(), -->
<!--       panel.spacing = unit(0, "pt"), -->
<!--       plot.margin = margin(0,0,0,0), -->
<!--       axis.ticks.length = unit(0, "pt") -->
<!--     ) -->
<!--   # Save the image -->
<!--   # ggsave( -->
<!--   #   filename = file.path(output_dir, paste0(image_filename, ".png")), -->
<!--   #   plot = p, -->
<!--   #   width = 3,  -->
<!--   #   height = 3, -->
<!--   #   dpi = 250 -->
<!--   #    -->
<!--   # ) -->
<!-- agg_png( -->
<!--   filename = file.path(output_dir, paste0(image_filename, ".png")), -->
<!--   width = 3, -->
<!--   height = 2.6, -->
<!--   units = "in", -->
<!--   res = 250 -->
<!-- ) -->
<!-- print(p) -->
<!-- dev.off() -->
<!-- } -->
<!-- ``` -->
<!-- ## ***Version 2: Range (SoH)- inside the battery -->
<!-- ```{r} -->
<!-- df_range_SOH_long <- df_range_SOH %>% -->
<!--   mutate(row_id = row_number()) %>% -->
<!--   pivot_longer( -->
<!--     cols = -row_id, -->
<!--     names_to = c("metric", "year"), -->
<!--     names_pattern = "(.*)_year(\\d+)", -->
<!--     values_to = "value" -->
<!--   ) %>% -->
<!--   pivot_wider( -->
<!--     names_from = metric, -->
<!--     values_from = value -->
<!--   ) %>% -->
<!--   group_by(row_id) %>% -->
<!--   mutate(battery_range_max = max(battery_range)) %>% -->
<!--   ungroup() %>% -->
<!--   left_join(df_battery_degradation %>% select(-battery_range_year0), by= c("row_id"="battery_degradation_id")) %>%  -->
<!--   mutate( -->
<!--     year = as.numeric(year), -->
<!--     label = paste0(battery_range, "mi (", battery_health*100, "%)"), -->
<!--     image_name = paste0("Range_Degradation_",battery_range_max, "_", battery_degradation*100), -->
<!--   ) %>% -->
<!--   select(-battery_degradation) -->
<!-- ``` -->
<!-- #### Full image -->
<!-- ```{r} -->
<!-- library(ggplot2) -->
<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- library(scales) -->
<!-- segments <- 100 -->
<!-- max_battery_health <- 1 -->
<!-- segment_width <- max_battery_health / segments -->
<!-- # Create visual bar representation by 100% -->
<!-- df_segmented <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     row_id = factor(row_id), -->
<!--     fill_color = alpha(col_numeric(c("brown","red", "yellow", "green"), domain = c(0.5, 1))(battery_health),alpha = 0.6), -->
<!--     visual_filled = ceiling(battery_health * segments), -->
<!--     y_center = as.numeric(factor(year)) -->
<!--   ) %>% -->
<!--   uncount(weights = segments, .id = "segment") %>% -->
<!--   group_by(row_id, year) %>% -->
<!--   mutate( -->
<!--     total_width = unique(battery_range_max), -->
<!--     segment_width = total_width / segments, -->
<!--     filled = segment <= visual_filled, -->
<!--     xmin = (segment - 1) * segment_width, -->
<!--     xmax = segment * segment_width, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) %>% -->
<!--   ungroup() -->
<!-- # Battery outline -->
<!-- df_battery_outline <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     y_center = as.numeric(factor(year)), -->
<!--     xmin = 0, -->
<!--     xmax = battery_range_max, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) -->
<!-- # Terminal -->
<!-- df_terminal <-df_battery_outline %>% -->
<!--   mutate( -->
<!--     xmin = battery_range_max, -->
<!--     xmax = battery_range_max + 15, -->
<!--     ymin = ymin + 0.1, -->
<!--     ymax = ymax - 0.1 -->
<!--   ) -->
<!-- # Plot -->
<!-- Range_SoH_full_image<-ggplot() + -->
<!--   geom_rect( -->
<!--     data = df_segmented, #%>% filter(row_id==1), -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = ifelse(filled, fill_color, "white")), -->
<!--     color = NA -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_battery_outline, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = NA, color = "black", linewidth = 0.6 -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_terminal, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = "black" -->
<!--   ) + -->
<!--   scale_fill_identity() + -->
<!--   facet_wrap(~ row_id) + #, scales = "free_y" -->
<!--   coord_cartesian(xlim = c(0, max(df_range_SOH_long$battery_range_max)),clip = "off") + -->
<!--   scale_y_reverse(limits = c(3.6, 0.4), -->
<!--                   breaks = c(3, 2, 1),  # Positions for ticks -->
<!--                   labels = c("Future\n(in 5 yrs)","Today\n(at 3 yrs old)","Initial\ncondition"))+ -->
<!--    geom_text( -->
<!--     data = df_range_SOH_long, -->
<!--     aes(x = 5, y = as.numeric(factor(year)), label = label), -->
<!--     hjust = 0, size = 4.4 -->
<!--   )+ -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     axis.title = element_blank(), -->
<!--     axis.text.x = element_blank(), -->
<!--     axis.text.y = element_text(colour="black", size = 12), -->
<!--     axis.ticks = element_blank(), -->
<!--     panel.grid = element_blank() -->
<!--   ) -->
<!-- # ggsave(plot = Range_SoH_full_image, filename  = here::here("survey","images","battery_choices", "SoH_range_full_image.png"), width = 15, height = 12) -->
<!-- ggsave(plot = Range_SoH_full_image, filename  = here::here("images","battery_choices_version2", "SoH_range_full_image.png"), width = 18, height = 12) -->
<!-- ``` -->
<!-- #### Individual image -->
<!-- ```{r} -->
<!--  library(ragg) -->
<!-- # Create output directory if it doesn't exist -->
<!-- # output_dir <- here::here("survey", "images", "battery_choices") -->
<!-- output_dir <- here::here( "images", "battery_choices_version2") -->
<!-- if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE) -->
<!-- # Get unique row_ids -->
<!-- row_ids <- unique(df_segmented$row_id) -->
<!-- for (id in row_ids) { -->
<!--   # Filter data for this row_id -->
<!--   segmented_i <- df_segmented %>% filter(row_id == id) -->
<!--   outline_i   <- df_battery_outline %>% filter(row_id == id) -->
<!--   terminal_i  <- df_terminal %>% filter(row_id == id) -->
<!--   label_i     <- df_range_SOH_long %>% filter(row_id == id) -->
<!--   # Get the image name -->
<!--   image_filename <- label_i$image_name[1]  # Assuming it's the same for all years per row_id -->
<!--   # Build the plot -->
<!--   p <- ggplot() + -->
<!--     geom_rect( -->
<!--       data = segmented_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, -->
<!--           fill = ifelse(filled, fill_color, "white")), -->
<!--       color = NA -->
<!--     ) + -->
<!--     geom_rect( -->
<!--       data = outline_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--       fill = NA, color = "black", linewidth = 0.6 -->
<!--     ) + -->
<!--     geom_rect( -->
<!--       data = terminal_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--       fill = "black" -->
<!--     ) + -->
<!--     scale_fill_identity() + -->
<!--     coord_cartesian(xlim = c(0, max(df_range_SOH_long$battery_range_max)),  clip = "off") + -->
<!--     scale_y_reverse( -->
<!--       limits = c(3.6, 0.4), -->
<!--       breaks = c(3, 2, 1), -->
<!--       labels = c("Future\n(in 5 yrs)","Today\n(at 3 yrs old)","Initial\ncondition"))+ -->
<!--     geom_text( -->
<!--       data = label_i, -->
<!--       aes(x = 5, y = as.numeric(factor(year)), label = label), -->
<!--       hjust = 0, size = 5.5 -->
<!--     ) + -->
<!--     # theme_minimal() + -->
<!--     theme( -->
<!--       axis.title = element_blank(), -->
<!--       axis.text.x =element_blank(), -->
<!--       axis.text.y = element_text(colour = "black", size = 16), -->
<!--       axis.ticks = element_blank(), -->
<!--       panel.grid = element_blank(), -->
<!--       panel.spacing = unit(0, "pt"), -->
<!--       plot.margin = margin(0,0,0,0), -->
<!--       axis.ticks.length = unit(0, "pt"), -->
<!--     panel.background = element_rect(fill = NA, color = NA), -->
<!--     plot.background = element_rect(fill = NA, color = NA) -->
<!--     ) -->
<!--   # Save the image -->
<!--   # ggsave( -->
<!--   #   filename = file.path(output_dir, paste0(image_filename, ".png")), -->
<!--   #   plot = p, -->
<!--   #   width = 3,  -->
<!--   #   height = 3, -->
<!--   #   dpi = 250 -->
<!--   #    -->
<!--   # ) -->
<!-- agg_png( -->
<!--   filename = file.path(output_dir, paste0(image_filename, ".png")), -->
<!--   width = 4, -->
<!--   height = 2.6, -->
<!--   units = "in", -->
<!--   res = 250, -->
<!--   background = "transparent" -->
<!-- ) -->
<!-- print(p) -->
<!-- dev.off() -->
<!-- } -->
<!-- ``` -->
<!-- ## Version 3: Range (SoH)- outside the battery -->
<!-- ```{r} -->
<!-- df_range_SOH_long <- df_range_SOH %>% -->
<!--   mutate(row_id = row_number()) %>% -->
<!--   pivot_longer( -->
<!--     cols = -row_id, -->
<!--     names_to = c("metric", "year"), -->
<!--     names_pattern = "(.*)_year(\\d+)", -->
<!--     values_to = "value" -->
<!--   ) %>% -->
<!--   pivot_wider( -->
<!--     names_from = metric, -->
<!--     values_from = value -->
<!--   ) %>% -->
<!--   group_by(row_id) %>% -->
<!--   mutate(battery_range_max = max(battery_range)) %>% -->
<!--   ungroup() %>% -->
<!--   left_join(df_battery_degradation %>% select(-battery_range_year0), by= c("row_id"="battery_degradation_id")) %>%  -->
<!--   mutate( -->
<!--     year = as.numeric(year), -->
<!--     label = paste0(battery_range, " mi\n(", battery_health*100, "%)"), -->
<!--     image_name = paste0("Range_Degradation_",battery_range_max, "_", battery_degradation*100), -->
<!--   ) %>% -->
<!--   select(-battery_degradation) -->
<!-- ``` -->
<!-- #### Full image -->
<!-- ```{r} -->
<!-- library(ggplot2) -->
<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- library(scales) -->
<!-- segments <- 100 -->
<!-- max_battery_health <- 1 -->
<!-- segment_width <- max_battery_health / segments -->
<!-- # Create visual bar representation by 100% -->
<!-- df_segmented <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     row_id = factor(row_id), -->
<!--     fill_color = col_numeric(c("brown","red", "yellow", "green"), domain = c(0.5, 1))(battery_health), -->
<!--     visual_filled = ceiling(battery_health * segments), -->
<!--     y_center = as.numeric(factor(year)) -->
<!--   ) %>% -->
<!--   uncount(weights = segments, .id = "segment") %>% -->
<!--   group_by(row_id, year) %>% -->
<!--   mutate( -->
<!--     total_width = unique(battery_range_max), -->
<!--     segment_width = total_width / segments, -->
<!--     filled = segment <= visual_filled, -->
<!--     xmin = (segment - 1) * segment_width, -->
<!--     xmax = segment * segment_width, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) %>% -->
<!--   ungroup() -->
<!-- # Battery outline -->
<!-- df_battery_outline <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     y_center = as.numeric(factor(year)), -->
<!--     xmin = 0, -->
<!--     xmax = battery_range_max, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) -->
<!-- # Terminal -->
<!-- df_terminal <-df_battery_outline %>% -->
<!--   mutate( -->
<!--     xmin = battery_range_max, -->
<!--     xmax = battery_range_max + 15, -->
<!--     ymin = ymin + 0.1, -->
<!--     ymax = ymax - 0.1 -->
<!--   ) -->
<!-- # Plot -->
<!-- Range_SoH_full_image<-ggplot() + -->
<!--   geom_rect( -->
<!--     data = df_segmented, #%>% filter(row_id==1), -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = ifelse(filled, fill_color, "white")), -->
<!--     color = NA -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_battery_outline, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = NA, color = "black", linewidth = 0.6 -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_terminal, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = "black" -->
<!--   ) + -->
<!--   scale_fill_identity() + -->
<!--   facet_wrap(~ row_id) + #, scales = "free_y" -->
<!--   coord_cartesian(xlim = c(0, max(df_range_SOH_long$battery_range_max)+300),clip = "off") + -->
<!--   scale_y_reverse(limits = c(3.6, 0.4), -->
<!--                   breaks = c(3, 2, 1),  # Positions for ticks -->
<!--                   labels = c("Future\n(in 5 yrs)","Today\n(at 3 yrs old)","Initial\ncondition"))+ -->
<!--    geom_text( -->
<!--     data = df_range_SOH_long, -->
<!--     aes(x = 360+40, y = as.numeric(factor(year)), label = label), -->
<!--     hjust = 0, size = 3 -->
<!--   )+ -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     axis.title = element_blank(), -->
<!--     axis.text.x = element_blank(), -->
<!--     axis.text.y = element_text(colour="black", size = 10), -->
<!--     axis.ticks = element_blank(), -->
<!--     panel.grid = element_blank() -->
<!--   ) -->
<!-- # ggsave(plot = Range_SoH_full_image, filename  = here::here("survey","images","battery_choices", "SoH_range_full_image.png"), width = 15, height = 12) -->
<!-- ggsave(plot = Range_SoH_full_image, filename  = here::here("images","battery_choices_version3", "SoH_range_full_image.png"), width = 14, height = 10) -->
<!-- ``` -->
<!-- #### Individual image -->
<!-- ```{r} -->
<!--  library(ragg) -->
<!-- # Create output directory if it doesn't exist -->
<!-- # output_dir <- here::here("survey", "images", "battery_choices") -->
<!-- output_dir <- here::here( "images", "battery_choices_version3") -->
<!-- if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE) -->
<!-- # Get unique row_ids -->
<!-- row_ids <- unique(df_segmented$row_id) -->
<!-- for (id in row_ids) { -->
<!--   # Filter data for this row_id -->
<!--   segmented_i <- df_segmented %>% filter(row_id == id) -->
<!--   outline_i   <- df_battery_outline %>% filter(row_id == id) -->
<!--   terminal_i  <- df_terminal %>% filter(row_id == id) -->
<!--   label_i     <- df_range_SOH_long %>% filter(row_id == id) -->
<!--   # Get the image name -->
<!--   image_filename <- label_i$image_name[1]  # Assuming it's the same for all years per row_id -->
<!--   # Build the plot -->
<!--   p <- ggplot() + -->
<!--     geom_rect( -->
<!--       data = segmented_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, -->
<!--           fill = ifelse(filled, fill_color, "white")), -->
<!--       color = NA -->
<!--     ) + -->
<!--     geom_rect( -->
<!--       data = outline_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--       fill = NA, color = "black", linewidth = 0.6 -->
<!--     ) + -->
<!--     geom_rect( -->
<!--       data = terminal_i, -->
<!--       aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--       fill = "black" -->
<!--     ) + -->
<!--     scale_fill_identity() + -->
<!--     coord_cartesian(xlim = c(0, max(df_range_SOH_long$battery_range_max)+200),  clip = "off") + -->
<!--     scale_y_reverse( -->
<!--       limits = c(3.6, 0.4), -->
<!--       breaks = c(3, 2, 1), -->
<!--       labels = c("Future\n(in 5 yrs)","Today\n(at 3 yrs old)","Initial\ncondition"))+ -->
<!--     geom_text( -->
<!--       data = label_i, -->
<!--       aes(x = 360+40, y = as.numeric(factor(year)), label = label), -->
<!--       hjust = 0, size = 5 -->
<!--     ) + -->
<!--     theme_minimal() + -->
<!--     theme( -->
<!--       axis.title = element_blank(), -->
<!--       axis.text.x =element_blank(), -->
<!--       axis.text.y = element_text(colour = "black", size = 14), -->
<!--       axis.ticks = element_blank(), -->
<!--       panel.grid = element_blank(), -->
<!--       panel.spacing = unit(0, "pt"), -->
<!--       plot.margin = margin(0,0,0,0), -->
<!--       axis.ticks.length = unit(0, "pt") -->
<!--     ) -->
<!--   # Save the image -->
<!--   # ggsave( -->
<!--   #   filename = file.path(output_dir, paste0(image_filename, ".png")), -->
<!--   #   plot = p, -->
<!--   #   width = 3,  -->
<!--   #   height = 3, -->
<!--   #   dpi = 250 -->
<!--   #    -->
<!--   # ) -->
<!-- agg_png( -->
<!--   filename = file.path(output_dir, paste0(image_filename, ".png")), -->
<!--   width = 4, -->
<!--   height = 2.6, -->
<!--   units = "in", -->
<!--   res = 250 -->
<!-- ) -->
<!-- print(p) -->
<!-- dev.off() -->
<!-- } -->
<!-- ``` -->
<!-- Simulate random choices -->
<!-- ```{r} -->
<!-- data_rand <- cbc_choices( -->
<!--     design = design_rand, -->
<!--     obsID = "obsID" -->
<!-- ) -->
<!-- ``` -->
<!-- Run power analysis -->
<!-- ```{r,echo=FALSE} -->
<!-- # model <- logitr( -->
<!-- #     data    = data_rand, -->
<!-- #     pars    = c('veh_mileage', 'veh_price','battery_condition', 'battery_refurbish', 'battery_range_year0','battery_degradation','charge_freq','charge_DCFC'), -->
<!-- #     outcome = "choice", -->
<!-- #     obsID   = "obsID" -->
<!-- # ) -->
<!-- # summary(model) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- power_rand <- cbc_power( -->
<!--     nbreaks = 20, -->
<!--     n_q     = 6, -->
<!--     data    = data_rand, -->
<!--     pars    = c('veh_mileage', 'veh_price','battery_condition', 'battery_refurbish', 'battery_range_year0','battery_degradation','charge_freq','charge_DCFC'), -->
<!--     outcome = "choice", -->
<!--     obsID   = "obsID" -->
<!-- ) -->
<!-- head(power_rand) -->
<!-- tail(power_rand) -->
<!-- ``` -->
<!-- Here is a summary of the standard errors for each sample size: -->
<!-- ```{r} -->
<!-- ggplot(power_rand) + -->
<!--   geom_hline(yintercept = 0.05, color = "red", linetype = 2) + -->
<!--   geom_point(aes(x = sampleSize, y = se, color = coef)) + -->
<!--   expand_limits(y = 0) + -->
<!--   scale_y_continuous(limits = c(0, 0.125)) + -->
<!--   theme_bw() +  -->
<!--   labs( -->
<!--     x = "Sample size",  -->
<!--     y = "Standard error",  -->
<!--     color = "Coefficient" -->
<!--   ) -->
<!-- ``` -->
<!-- # Achived codes -->
<!-- ### differ by SoH -->
<!-- ```{r} -->
<!-- library(ggplot2) -->
<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- library(scales) -->
<!-- segments <- 100 -->
<!-- max_battery_health <- 1 -->
<!-- segment_width <- max_battery_health / segments -->
<!-- # Create visual bar representation by 100% -->
<!-- df_segmented <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     row_id = factor(row_id), -->
<!--     fill_color = col_numeric(c("red", "yellow", "green"), domain = c(0.4, 1))(battery_health), -->
<!--     visual_filled = ceiling(battery_health * segments), -->
<!--     y_center = as.numeric(factor(year)) -->
<!--   ) %>% -->
<!--   uncount(weights = segments, .id = "segment") %>% -->
<!--   mutate( -->
<!--     filled = segment <= visual_filled, -->
<!--     xmin = (segment - 1) * segment_width, -->
<!--     xmax = segment * segment_width, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) -->
<!-- # Battery outline -->
<!-- df_battery_outline <- df_range_SOH_long %>% -->
<!--   mutate( -->
<!--     row_id = factor(row_id), -->
<!--     y_center = as.numeric(factor(year)), -->
<!--     xmin = 0, -->
<!--     xmax = max_battery_health, -->
<!--     ymin = y_center - 0.3, -->
<!--     ymax = y_center + 0.3 -->
<!--   ) -->
<!-- # Terminal -->
<!-- df_terminal <-df_battery_outline %>% -->
<!--   mutate( -->
<!--     xmin = max_battery_health, -->
<!--     xmax = max_battery_health + 0.05, -->
<!--     ymin = ymin + 0.1, -->
<!--     ymax = ymax - 0.1 -->
<!--   ) -->
<!-- # Plot -->
<!-- ggplot() + -->
<!--   geom_rect( -->
<!--     data = df_segmented, #%>% filter(row_id==1), -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = ifelse(filled, fill_color, "white")), -->
<!--     color = NA -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_battery_outline, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = NA, color = "black", linewidth = 0.6 -->
<!--   ) + -->
<!--   geom_rect( -->
<!--     data = df_terminal, -->
<!--     aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), -->
<!--     fill = "black" -->
<!--   ) + -->
<!--   scale_fill_identity() + -->
<!--   facet_wrap(~ row_id) + #, scales = "free_y" -->
<!--   coord_cartesian(xlim = c(0, max_battery_health + 0.15)) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     axis.title = element_blank(), -->
<!--     axis.text = element_blank(), -->
<!--     axis.ticks = element_blank(), -->
<!--     panel.grid = element_blank() -->
<!--   ) -->
<!-- ``` -->
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>